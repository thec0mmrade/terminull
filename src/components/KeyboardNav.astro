---
// Keyboard navigation Web Component
// Handles j/k navigation, number keys, Enter, Escape, ?, /, p, n
---

<keyboard-nav>
  <slot />
</keyboard-nav>

<script>
  class KeyboardNavElement extends HTMLElement {
    private activeIndex = -1;
    private items: HTMLElement[] = [];

    connectedCallback() {
      this.init();
      document.addEventListener('astro:after-swap', () => this.init());
    }

    init() {
      this.items = Array.from(document.querySelectorAll('[data-nav-item]'));
      this.activeIndex = -1;

      document.addEventListener('keydown', (e) => this.handleKey(e));
    }

    setActive(index: number) {
      // Remove active from all
      this.items.forEach(item => item.classList.remove('nav-active'));

      if (index < 0 || index >= this.items.length) {
        this.activeIndex = -1;
        return;
      }

      this.activeIndex = index;
      const item = this.items[index];
      item.classList.add('nav-active');
      item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    handleKey(e: KeyboardEvent) {
      // Don't handle keys when input is focused
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) {
        return;
      }

      // Don't handle keys when overlays are active
      const helpActive = document.querySelector('.help-overlay.active');
      const searchActive = document.querySelector('.search-overlay.active');
      if (searchActive) {
        if (e.key === 'Escape') {
          (window as any).closeSearch?.();
          e.preventDefault();
        }
        return;
      }

      switch (e.key) {
        case 'j':
        case 'ArrowDown':
          e.preventDefault();
          if (this.items.length === 0) break;
          this.setActive(Math.min(this.activeIndex + 1, this.items.length - 1));
          break;

        case 'k':
        case 'ArrowUp':
          e.preventDefault();
          if (this.items.length === 0) break;
          this.setActive(Math.max(this.activeIndex - 1, 0));
          break;

        case 'Enter':
          if (this.activeIndex >= 0 && this.activeIndex < this.items.length) {
            e.preventDefault();
            const link = this.items[this.activeIndex].querySelector('a') as HTMLAnchorElement;
            if (link) link.click();
          }
          break;

        case 'Escape':
          if (helpActive) {
            (window as any).toggleHelp?.();
            e.preventDefault();
          } else {
            window.history.back();
          }
          break;

        case 'q':
          if (!helpActive) {
            window.history.back();
          } else {
            (window as any).toggleHelp?.();
            e.preventDefault();
          }
          break;

        case '?':
          e.preventDefault();
          (window as any).toggleHelp?.();
          break;

        case '/':
        case ':':
          e.preventDefault();
          (window as any).focusPrompt?.();
          break;

        case 'p': {
          const prevLink = document.querySelector('.article-nav__prev') as HTMLAnchorElement;
          if (prevLink) {
            e.preventDefault();
            prevLink.click();
          }
          break;
        }

        case 'n': {
          const nextLink = document.querySelector('.article-nav__next') as HTMLAnchorElement;
          if (nextLink) {
            e.preventDefault();
            nextLink.click();
          }
          break;
        }

        default: {
          // Number key quick-jump
          const num = parseInt(e.key);
          if (!isNaN(num) && num >= 0 && num <= 9) {
            const targetItem = this.items.find(
              item => item.getAttribute('data-nav-index') === String(num)
            );
            if (targetItem) {
              e.preventDefault();
              const index = this.items.indexOf(targetItem);
              this.setActive(index);
              const link = targetItem.querySelector('a') as HTMLAnchorElement;
              if (link) {
                setTimeout(() => link.click(), 150);
              }
            }
          }
          break;
        }
      }
    }
  }

  customElements.define('keyboard-nav', KeyboardNavElement);
</script>
